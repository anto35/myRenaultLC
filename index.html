<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="PSPad editor, www.pspad.com">
  <title>Unofficial MyRenault dashboard for browsers</title>

<!--<script src="myrenault-secret.js"></script>-->
<script src="myrenault-public.js"></script>
  <script>

//USERNAME=mydata.email;
//P=mydata.pass;


GIGYA_API_KEY = null;
KAMEREON_KEY = null;

JWTextracted = null;

function init() {
	gigyaurl = data.servers.gigyaProd.target;
	GIGYA_API_KEY= newData.servers.gigyaProd.apikey;
	kamereonurl = data.servers.wiredProd.target;
	KAMEREON_KEY = newData.servers.wiredProd.apikey;
//	document.getElementById("mail").value = mydata.mail;
//	document.getElementById("pass").value = mydata.pass;
	//document.getElementById("personId").value = mydata.personId;
	//document.getElementById("accountId").value = mydata.accountId1;
//	document.getElementById("MY_VIN").value = mydata.VIN;
}


function retrieve(fullURL, path1, path2) {
		finalURL = "http://win98.altervista.org/space/exploration/myp.php?pass=miapass&mode=native&url=" + encodeURIComponent(fullURL);
		var client = new XMLHttpRequest();
		client.open('GET',finalURL);

		client.setRequestHeader("Content-type","application/vnd.api+json");

		client.onreadystatechange = function () {
			if (client.readyState === 4) {
				console.log("Status: ", client.status);
				//console.log("Response: ", client.responseText);
				var data = client.responseText; // Load remote response.
				//console.log("### ok - Contents: ", data);
				JSONdata = JSON.parse(data)
				//console.log("### ok - Contents: ", JSONdata);
				data1 = JSONdata[path1];
				data2 = data1[path2];
				console.log("Extracting 2", data2);
				return data2;
			}
		}

	    client.onprogress = function(event) {
	  		console.log("Response length:" , client.response.length);
		};

		client.responseType = 'text';

		client.onload = function() {
			console.log("### ok - Response received");

		};

	    client.onerror = function(event) {
			console.log("**** err -  NETWORK ERROR while preloading data**");
		};

		console.log("### Sending request for " + finalURL + " ...");
		client.send(); // Async connection to data server.
}



function request(url, setMyHeader) {
console.log("Processing " , url , "...");
  return new Promise(function (resolve, reject) {
    const xhr = new XMLHttpRequest();
    xhr.timeout = 2000;
    xhr.onreadystatechange = function(e) {
      if (xhr.readyState === 4) {
//console.log("Status=4");
        if (xhr.status === 200) {
//console.log(">>>>>>>>>>Risposta ad URL " , url , ":", xhr.response);
          resolve(xhr.response)
        } else {
			console.log("not 200");
			output.value = "Error " + xhr.status;
          reject(xhr.status)
        }
      } else {
//console.log("Ongoing,Status=", xhr.readyState);
	  }
    }
    xhr.ontimeout = function () {
      reject('timeout')
    }

	if (setMyHeader === true) {
console.log("======= richiesta speciale con headers");
console.log("url:",decodeURIComponent(url));
    	xhr.open('get', url  , true)
        xhr.setRequestHeader("x-gigya-id_token",JWT.value);
        xhr.setRequestHeader("apikey",KAMEREON_KEY);
        xhr.setRequestHeader("Content-type","application/vnd.api+json");
	} else {
    	xhr.open('get', url , true)
//
	}

	xhr.send();
  })
}

function main() {
    output.value = "";
	cookieValue.value="waiting...";
	JWT.value = "waiting...";
	personId.value = "waiting...";
	accountId.value = "waiting...";
	init();
	loginUrl =  gigyaurl + "/accounts.login?loginID=" + username.value + "&password=" + password.value + "&apikey=" + GIGYA_API_KEY;
	finalLoginURL =  "http://win98.altervista.org/space/exploration/myp.php?pass=miapass&mode=native&url=" + encodeURIComponent(loginUrl);
	path1 = "sessionInfo";
	path2 = "cookieValue";

	const requestsList = request(finalLoginURL);
	requestsList
	  .then(initialLogin)
	  .then(getJWTtoken)
	  .catch(errore)
}


function initialLogin(loginResponse) {
console.log("====LOGIN",loginResponse);
	loginResult = JSON.parse(loginResponse);
	cookieValue.value = loginResult.sessionInfo.cookieValue;
//console.log("Cookie=", loginResult.sessionInfo.cookieValue);
	return(loginResult.sessionInfo.cookieValue)
}


function getJWTtoken(cookie) {
output.value +="Logged in.\n";
console.log("====JWT");
	JWTurl = "https://gigya-it-it.renault.it/accounts.getJWT?fields=data.personId%2Cdata.gigyaDataCenter&expiration=600&APIKey=" + GIGYA_API_KEY +
	"&sdk=js_latest&authMode=cookie&pageURL=https%3A%2F%2Fmyr.renault.it%2F&sdkBuild=12426&format=json&login_token=" +	cookie;
	finalJWTurl= "http://win98.altervista.org/space/exploration/myp.php?pass=miapass&mode=native&url=" + encodeURIComponent(JWTurl);
//console.log("Processing ", finalJWTurl);
	const JWTrequest = request(finalJWTurl);
	JWTrequest
	  .then(extractJWT)
	  .then(getPersonId)
	  .catch(JWTerror)
	return (cookie);
}


function getPersonId(cookie) {
output.value +="Found JWT\n";

console.log("====personId");
	var personUrl = gigyaurl + "/accounts.getAccountInfo?apikey=" + GIGYA_API_KEY + "&login_token=" + cookieValue.value;
	var finalPersonurl= "http://win98.altervista.org/space/exploration/myp.php?pass=miapass&mode=native&url=" + encodeURIComponent(personUrl);
	const personIdRequest = request(finalPersonurl);
	personIdRequest
	  .then(extractPersonId)
	  .then(getAccountId)
	  .catch(personIdError)
	return (cookie);
}

function getAccountId(cookie) {
output.value +="Found Person Id.\n";

console.log("====accountId");
	accountUrl = kamereonurl + "/commerce/v1/persons/" +
	personId.value +
	"?apikey=" + KAMEREON_KEY +
	"&country=" + country.value;
	var finalAccounturl= "http://win98.altervista.org/space/exploration/myp.php?pass=miapass&mode=native&url=" + encodeURIComponent(accountUrl);
	const accountIdRequest = request(accountUrl, true);  // DEBUG!! tolto CORS!
	accountIdRequest
	  .then(extractAccountId)
	  .then(getVehicleData)
	  .catch(accountIdError)
	return (cookie);
}



function getVehicleData(a) {
output.value +="Found account, sending query...\n";
	console.log("=== QUERY");
	queryUrl = kamereonurl + "/commerce/v1/accounts/" +
		accountId.value +
		"/kamereon/kca/car-adapter/v1/cars/" + MY_VIN.value +
		"/" +
		endpoint.value +
		"?apikey=" + KAMEREON_KEY +
		"&country=" + country.value;
	finalQueryUrl= "http://win98.altervista.org/space/exploration/myp.php?pass=miapass&mode=native&url=" + encodeURIComponent(queryUrl);

console.log("finalQueryUrl ", queryUrl);

	const sendQuery = request(queryUrl, true); // DEBUG!! tolto CORS!
	sendQuery
	  .then(showResults)
	  .catch(vehicleError)
	return ("query finished.");
}


function extractJWT(JWTresponse) {
	//console.log("JWTresponse:" , JWTresponse);
	var JSONdata = JSON.parse(JWTresponse);
	//console.log("Extracted:" , JSONdata.id_token);
	JWT.value = JSONdata.id_token;
	//return ("JWT: ", JSONdata.id_token);
}


function extractPersonId(personIdResponse) {
//	console.log("============personIdResponse:" , personIdResponse);
//document.getElementById("status").innerHTML = personIdResponse;
	var JSONdata = JSON.parse(personIdResponse);
	console.log("Extracted:" , JSONdata.data.personId);
	personId.value = JSONdata.data.personId;
	//return ("PersonId: ", JSONdata.data.personId);
}

function extractAccountId(accountIdResponse) {
	console.log("============ accountIdResponse:");// , accountIdResponse);
//document.getElementById("status").innerHTML = accountIdResponse;
	var JSONdata = JSON.parse(accountIdResponse);
	console.log("Extracted:" , JSONdata.accounts[0].accountId);
	accountId.value = JSONdata.accounts[0].accountId;
	//return ("PersonId: ", JSONdata.data.personId);
}



function showResults(queryResponse) {
	console.log("queryResponse:" , queryResponse);
//	document.getElementById("status").innerHTML = queryResponse;
	JSONdataFinal = JSON.parse(queryResponse);
	console.log("Extracted:" , JSONdataFinal);
	output.value = queryResponse;
//	status.innerHTML = queryResponse;
}



function errore(e) {
	console.log(e);
	return ("Errore");
}


function JWTerror(e) {
	console.log(e);
	JWT.value="error";
	return ("Errore JWT");
}



function personIdError(e) {
	console.log(e);
	personId.value = "error";
	
	return ("Errore PersonId");
}



function accountIdError(e) {
	console.log(e);
	accountId.value = "error";
	return ("Errore accountId");
}


function vehicleError(e) {
	console.log(e);
	output.innerHTML = "Vehicle query error";
	return ("Errore PersonId");
}


function createGigyaTokenLink() {
	init();
	document.getElementById("cookieValue").value="Paste cookieValue here";
	url =  gigyaurl + "/accounts.login?loginID=" + username.value + "&password=" + pass.value + "&apikey=" + GIGYA_API_KEY;
	encodedURL = encodeURIComponent(url);
	document.getElementById("cookieLink").innerHTML = "<a href='" + url + "'>get Gigya Token</a>";
    startCountdown();
}

function createPersonIdLink() {
	init();
	document.getElementById("personId").value="Paste PersonId here";
	url = gigyaurl + "/accounts.getAccountInfo?apikey=" + GIGYA_API_KEY + "&login_token=" + cookieValue.value;
	document.getElementById("personIdLink").innerHTML = "<a href='" + url + "'>get Kamereon PersonId</a>";
}


/*
https://gigya-it-it.renault.it/accounts.getJWT?fields=data.personId%2Cdata.gigyaDataCenter&expiration=600&APIKey=3_js8th3jdmCWV86fKR3SXQWvXGKbHoWFv8NAgRbH7FnIBsi_XvCpN_rtLcI07uNuq&sdk=js_latest&authMode=cookie&pageURL=https%3A%2F%2Fmyr.renault.it%2F&sdkBuild=12426&format=json&login_token=MY_COOKIE
*/
function createJWTLink() {
	init();
	document.getElementById("JWT").value="Paste Id_token here";
//	url = gigyaurl + "/accounts.getJWT?apikey=" + GIGYA_API_KEY + "&login_token=" + cookieValue.value;
	url = "https://gigya-it-it.renault.it/accounts.getJWT?fields=data.personId%2Cdata.gigyaDataCenter&expiration=600&APIKey=" + GIGYA_API_KEY +
	"&sdk=js_latest&authMode=cookie&pageURL=https%3A%2F%2Fmyr.renault.it%2F&sdkBuild=12426&format=json&login_token=" +
	cookieValue.value;
	document.getElementById("JWTlink").innerHTML = "<a href='" + url + "'>get JWT</a>";
}

//https://api-wired-prod-1-euw1.wrd-aws.com/commerce/v1/persons/PERSONID?apikey=KAMEREON_KEY&x-gigya-id_token=GIGYA_JWT&country=IT
function createAccountLink() {
	init();
	document.getElementById("accountId").value="Paste Account Id here";
	url = kamereonurl + "/commerce/v1/persons/" +
	personId.value +
	"?apikey=" + KAMEREON_KEY +
	//"&x-gigya-id_token=" +  JWT.value +
	"&country=" + country.value;

	document.getElementById("accountLink").innerHTML =
	"<br>Use <a href='" + url + "'>this link</a> to send a GET request with these headers:<br><pre>"+
	"Content-type: application/vnd.api+json<br>" +
	"x-gigya-id_token: "
	+ JWT.value + "<br></pre>";
}


// https://api-wired-prod-1-euw1.wrd-aws.com/commerce/v1/accounts/**MYACCOUNT**/kamereon/kca/car-adapter/v1/cars/**MYVIN**/location?country=IT
function createQueryLink() {
	init();
	url = kamereonurl + "/commerce/v1/accounts/" +
	accountId.value +
	"/kamereon/kca/car-adapter/v1/cars/" + MY_VIN.value +
	"/" +
	endpoint.value +
	"?country=" + country.value;

	document.getElementById("queryLink").innerHTML =
	"<br>Use <a href='" + url + "'>this url</a> to send a GET request with these headers:<br><pre>"+
	"Content-type: application/vnd.api+json<br>" +
	"apikey: " + KAMEREON_KEY + "<br>" +
	"x-gigya-id_token: " +
	JWT.value + "<br>" +
	"</pre>";
}

 function startCountdown() {
  var minute = 10;
  var sec = 59;
  if (myInterval != null) clearInterval(myInterval);
  var myInterval=setInterval(function() {
    document.getElementById("countdown").innerHTML = minute + " : " + sec;
    sec--;
    if (sec == 00) {
      minute --;
      sec = 59;
      if (minute == 0) {
        clearInterval(myInterval);
		alert("New login required!");
      }
    }
  }, 1000);
}

</script>

  </head>
  <body>
<a href="https://renault-wrd-prod-1-euw1-myrapp-one.s3-eu-west-1.amazonaws.com/configuration/android/config_it_IT.json">Gigya apikey e Kamereon Apikey - credentials file</a>
<br>
<br>
Time remaining to new login:<span id="countdown" name="countdown">-</span><br>
<br>
<br>
Gigya api key: <input type="text" id="gapikey" name="gapikey" size=100 value="3_js8th3jdmCWV86fKR3SXQWvXGKbHoWFv8NAgRbH7FnIBsi_XvCpN_rtLcI07uNuq"><br>
Kamereon key: <input type="text" id="kapikey" name="kapikey" size=100  value="Ae9FDWugRxZQAGm3Sxgk7uJn6Q4CGEA2"><br>
<br>
<center><b>Login (temporary data)</b></center><br>
<br>
<b>cookieValue</b> (Gigya session)<br>
Input:<br>
mail:<input type="text" id="username" name="username" value="--"><br>
password:<input type="password" id="password" name="pass" value="--"><br>
Gigya Api key (from above)<br>
<button onclick="createGigyaTokenLink()">Create link for Gigya token cookieValue</button>
<span id="cookieLink" name="cookieLink">-</span><br>
Paste "cookieValue"value  here:
<input type="text" id="cookieValue" name="cookieValue" value="---"  size = 100><br>
<br>

<b>Gigya JWT</b><br>
Input:<br>
Gigya Api key (from above)<br>
Gigya token (cookieValue) (from above)<br>
fields: data.personId,data.gigyaDataCenter<br>
expiration: 600<br>
<button onclick="createJWTLink()">Create link for Gigya JWT token</button>
<span id="JWTlink" name="JWTlink">-</span><br>
Paste "Id_token" value here:
<input type="text" id="JWT" name="JWT" value="---" size=100><br>
<br>
<br>
<center><b>Personal data (constant)</b></center><br>
<b>PersonId</b> for Kamereon<br>
Input:<br>
Gigya Api key (from above)<br>
Gigya token (cookieValue) (from above)<br>
<button onclick="createPersonIdLink()">Create link for Kamereon PersonId</button>
<span id="personIdLink" name="personIdLink">-</span><br>
Paste "PersonId" value here: <input type="text" id="personId" name="personId" value=".." size = 50><br>
<br>
<br>
<b>Account Id</b><br>
Input:<br>
Country: <input type="text" id="country" name="country"value="IT" size=4><br>
Kamereon Api key (from above)<br>
Gigya JWT (from above)<br>
<button onclick="createAccountLink()">Create link for Kamereon account</button>
<span id="accountLink" name="accountLink">-</span><br>
Paste accountId here: <input type="text" id="accountId" name="accountId" value=".." size=100><br>
<br>

<center><b>Vehicle query</b></center><br>
Input:<br>
	<ul>
	<li>url
    	<ul>
		<li>VIN: <input type="text" id="MY_VIN" name="MY_VIN" value="-">
		<li>endpoint:<input type="text" id="endpoint" name="endpoint" value=location>
		<button id="btnSend" name="btnSend" onclick="main()">Send query</button><br>
		<li>account Id (from above)
		<li>country (from above)
		</ul>
	</ul>
	<ul>
	<li>Header:
		<ul>
		<li>Kamereon key (from above)
		<li>JWT (from above)
		<li>Content type (from above)
		</ul>
	</ul>
Known endpoints:<br>
battery-status<br>
location<br>
hvac-status<br>
hvac-settings<br>
charge-mode<br>
cockpit<br>
lock-status<br>
charging-settings<br>
notification-settings<br>
charge-history<br>
charges<br>
hvac-history<br>
hvac-sessions<br>
hvac-start<br>
hvac-schedule<br>
charge-schedule<br>
charge-mode<br>
charging-start<br>
<br>
<button onclick="createQueryLink()">Create link for final query</button>
<span id="queryLink" name="queryLink">-</span><br>

Output:
<textarea id="output" name="output" value="output" cols=100 rows=10></textarea><br>
<br>

<span id="status" name="status">-</span><br>
  </body>
</html>
